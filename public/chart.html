<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Результаты опроса</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: white;
    }

    .container {
      display: flex;
      align-items: center;
      gap: 80px;
      padding: 40px;
    }

    .chart-wrapper {
      width: 900px;
      height: 900px;
    }

    .legend {
      font-size: 22px;
      line-height: 1.6;
    }

    .controls {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    button {
      padding: 14px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      color: white;
    }

    .back {
      background: #ef4444;
    }

    .reset {
      background: #111827;
    }

    button:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>

<div class="container">
  <div>
    <div class="chart-wrapper">
      <canvas id="chart"></canvas>
    </div>

    <div class="controls">
      <button class="back" onclick="goHome()">← На главную</button>
      <button class="reset" onclick="resetStats()">Сброс</button>
    </div>
  </div>

  <div class="legend" id="legend"></div>
</div>

<script>
/* ===== КАРТА ВОПРОСОВ ===== */
const QUESTIONS = {
  q1: [
    { id: "9008969287495770", label: "Дизайнер интерьеров" },
    { id: "1770032788433", label: "Археолог" },
    { id: "1770032780082", label: "Тренер ИИ" },
    { id: "1770032798666", label: "Лингвист" }
  ],
  q2: [
    { id: "9008969287733378", label: "VR-психолог" },
    { id: "1770033037788", label: "Киберспортсмен" },
    { id: "1770033025599", label: "Системный администратор" },
    { id: "1770033059616", label: "Маркетолог" }
  ],
  q3: [
    { id: "9008969287833078", label: "Космический гид" },
    { id: "1770033096942", label: "Астролог" },
    { id: "1770033099376", label: "Пилот самолёта" },
    { id: "1770033100502", label: "Геолог" }
  ],
  q4: [
    { id: "9008969313885382", label: "Урбан-эколог" },
    { id: "1770059333193", label: "Риелтор" },
    { id: "1770059336097", label: "Банковский аналитик" },
    { id: "1770059337204", label: "Юрист" }
  ],
  q5: [
    { id: "9008969313915506", label: "Биохакер" },
    { id: "1770059236597", label: "Экоинженер" },
    { id: "1770059243014", label: "Видеоблогер" },
    { id: "1770059245109", label: "Экономист" }
  ]
};

/* ===== ПАРАМЕТР ===== */
const params = new URLSearchParams(window.location.search);
const q = params.get('q');

/* НЕ РЕДИРЕКТИМ — ПРОСТО НЕ РИСУЕМ */
if (!q || !QUESTIONS[q]) {
  document.getElementById('legend').innerHTML = 'Нет данных';
}

/* ===== CHART ===== */
let chart;
const colors = ['#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0', '#9966ff'];

async function loadData() {
  if (!QUESTIONS[q]) return;

  const res = await fetch(`/api/stats?question=${q}`);
  const data = await res.json();

  const labels = [];
  const values = [];

  QUESTIONS[q].forEach(item => {
    labels.push(item.label);
    values.push(data[item.id] || 0);
  });

  const total = values.reduce((a, b) => a + b, 0) || 1;

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById('chart'), {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } }
    }
  });

  document.getElementById('legend').innerHTML = labels.map((l, i) => {
    const percent = ((values[i] / total) * 100).toFixed(1);
    return `<div><span style="color:${colors[i]}">■</span> ${l}: ${percent}%</div>`;
  }).join('');
}

function goHome() {
  location.href = 'index.html';
}

async function resetStats() {
  await fetch(`/api/reset?question=${q}`);
  loadData();
}

loadData();
setInterval(loadData, 200);
</script>

</body>
</html>
