<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Результаты опроса</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: white;
    }

    .container {
      display: flex;
      align-items: center;
      gap: 80px;
      padding: 40px;
    }

    .chart-wrapper {
      width: 900px;
      height: 900px;
    }

    .legend {
      font-size: 22px;
      line-height: 1.6;
    }

    .controls {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* === BUTTONS === */
    .btn {
      padding: 14px 22px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      color: white;
      min-width: 160px;
      height: 48px;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-back {
      background: #ef4444;
    }

    .btn-reset {
      background: #111827;
    }
  </style>
</head>
<body>

<div class="container">
  <div>
    <div class="chart-wrapper">
      <canvas id="chart"></canvas>
    </div>

    <div class="controls">
      <button class="btn btn-back" onclick="goHome()">← На главную</button>
      <button class="btn btn-reset" onclick="resetVotes()">Сброс</button>
    </div>
  </div>

  <div class="legend" id="legend"></div>
</div>

<script>
/* ===== КАРТА ВОПРОСОВ ===== */
const QUESTIONS = {
  q1: [
    { id: "9008969287495770", label: "Дизайнер интерьеров" },
    { id: "1770032788433", label: "Археолог" },
    { id: "1770032780082", label: "Тренер ИИ" },
    { id: "1770032798666", label: "Лингвист" }
  ],
  q2: [
    { id: "9008969287733378", label: "VR-психолог" },
    { id: "1770033037788", label: "Киберспортсмен" },
    { id: "1770033025599", label: "Системный администратор" },
    { id: "1770033059616", label: "Маркетолог" }
  ],
  q3: [
    { id: "9008969287833078", label: "Космический гид" },
    { id: "1770033096942", label: "Астролог" },
    { id: "1770033099376", label: "Пилот самолёта" },
    { id: "1770033100502", label: "Геолог" }
  ],
  q4: [
    { id: "9008969313885382", label: "Урбан-эколог" },
    { id: "1770059333193", label: "Риелтор" },
    { id: "1770059336097", label: "Банковский аналитик" },
    { id: "1770059337204", label: "Юрист" }
  ],
  q5: [
    { id: "9008969313915506", label: "Биохакер" },
    { id: "1770059236597", label: "Экоинженер" },
    { id: "1770059243014", label: "Видеоблогер" },
    { id: "1770059245109", label: "Экономист" }
  ]
};

/* ===== PARAM ===== */
const q = new URLSearchParams(window.location.search).get('q');
if (!q || !QUESTIONS[q]) {
  document.getElementById('legend').innerHTML = 'Нет данных';
}

/* ===== CHART INIT ===== */
const ctx = document.getElementById('chart');
const colors = ['#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0', '#9966ff'];

const labels = QUESTIONS[q].map(i => i.label);
const ids = QUESTIONS[q].map(i => i.id);

const chart = new Chart(ctx, {
  type: 'pie',
  data: {
    labels,
    datasets: [{
      data: new Array(ids.length).fill(0),
      backgroundColor: colors
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } }
  }
});

/* ===== UPDATE DATA (NO DESTROY) ===== */
async function loadData() {
  const res = await fetch(`/api/stats?q=${q}`, { cache: 'no-store' });
  const data = await res.json();

  const values = ids.map(id => data[id] || 0);
  chart.data.datasets[0].data = values;
  chart.update();

  const total = values.reduce((a,b)=>a+b,0) || 1;
  document.getElementById('legend').innerHTML = labels.map((l,i)=>`
    <div>
      <span style="color:${colors[i]}">■</span>
      ${l}: ${((values[i]/total)*100).toFixed(1)}%
    </div>
  `).join('');
}

/* ===== NAV ===== */
function goHome() {
  location.href = 'index.html';
}

/* ===== RESET ===== */
async function resetVotes() {
  if (!confirm('Сбросить все голоса для этого вопроса?')) return;
  await fetch(`/api/reset?q=${q}`, { method: 'POST' });
  await loadData();
}

/* ===== LIVE UPDATE ===== */
loadData();
setInterval(loadData, 1000); // ✅ стабильный live-режим
</script>

</body>
</html>
