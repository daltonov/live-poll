<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Результаты</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: white;
    }

    .container {
      display: flex;
      align-items: center;
      gap: 80px;
      padding: 40px;
    }

    .chart-wrapper {
      width: 900px;
      height: 900px;
    }

    .legend {
      font-size: 22px;
      line-height: 1.6;
    }

    .back-btn {
      margin-top: 20px;
      padding: 14px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #ef4444;
      color: white;
    }
  </style>
</head>
<body>

<div class="container">
  <div>
    <div class="chart-wrapper">
      <canvas id="chart"></canvas>
    </div>
    <button class="back-btn" onclick="location.href='index.html'">
      ← На главную
    </button>
  </div>

  <div class="legend" id="legend"></div>
</div>

<script>

const QUESTIONS = {
  q1: [
    { id: "9008969287495770", label: "Дизайнер интерьеров" },
    { id: "1770032788433", label: "Археолог" },
    { id: "1770032780082", label: "Тренер ИИ" },
    { id: "1770032798666", label: "Лингвист" }
  ],

  q2: [
    { id: "9008969287733378", label: "VR-психолог" },
    { id: "1770033037788", label: "Киберспортсмен" },
    { id: "1770033025599", label: "Системный администратор" },
    { id: "1770033059616", label: "Маркетолог" }
  ],

  q3: [
    { id: "9008969287833078", label: "Космический гид" },
    { id: "1770033096942", label: "Астролог" },
    { id: "1770033099376", label: "Пилот самолёта" },
    { id: "1770033100502", label: "Геолог" }
  ],

  q4: [
    { id: "9008969313885382", label: "Урбан-эколог" },
    { id: "1770059333193", label: "Риелтор" },
    { id: "1770059336097", label: "Банковский аналитик" },
    { id: "1770059337204", label: "Юрист" }
  ],

  q5: [
    { id: "9008969313915506", label: "Биохакер" },
    { id: "1770059236597", label: "Экоинженер" },
    { id: "1770059243014", label: "Видеоблогер" },
    { id: "1770059245109", label: "Экономист" }
  ]
};


const COLORS = ['#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0'];

const params = new URLSearchParams(location.search);
const question = params.get('q');
if (!QUESTIONS[question]) location.href = 'index.html';

const config = QUESTIONS[question];
const labels = config.map(a => a.label);
const ids = config.map(a => a.id);

const ctx = document.getElementById('chart');
const chart = new Chart(ctx, {
  type: 'pie',
  data: {
    labels,
    datasets: [{
      data: new Array(ids.length).fill(0),
      backgroundColor: COLORS
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    plugins: {
      legend: { display: false }
    }
  }
});

async function update() {
  const res = await fetch(`/api/stats?q=${question}`);
  const stats = await res.json();

  const values = ids.map(id => Number(stats[id] || 0));
  chart.data.datasets[0].data = values;
  chart.update('none');

  const total = values.reduce((a,b)=>a+b,0) || 1;
  document.getElementById('legend').innerHTML =
    labels.map((l,i)=>`
      <div>
        <span style="color:${COLORS[i]}">■</span>
        ${l}: ${((values[i]/total)*100).toFixed(1)}%
      </div>
    `).join('');
}

update();
setInterval(update, 1000); // ✅ плавно и стабильно
</script>

</body>
</html>
