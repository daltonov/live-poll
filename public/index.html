<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: white;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      display: flex;
      align-items: center;
      gap: 60px;
      max-width: 1200px;
      width: 100%;
      padding: 40px;
      box-sizing: border-box;
    }

    .chart-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 520px;
      height: 520px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    #resetBtn {
      margin-top: 20px;
      padding: 10px 18px;
      font-size: 14px;
      background: #ff4d4f;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #resetBtn:hover {
      background: #e04445;
    }

    .legend {
      font-size: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
      line-height: 1.3;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      margin-right: 10px;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="chart-wrapper">
    <canvas id="chart"></canvas>
    <button id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
  </div>

  <div id="legend" class="legend"></div>
</div>

<script>
  const REFRESH_INTERVAL = 0_300;
  
  // üîπ –ú–ê–ü–ü–ò–ù–ì –ö–û–î–û–í ‚Üí –¢–ï–ö–°–¢ –û–¢–í–ï–¢–û–í
  const ANSWER_LABELS = {
    "1770032780082": "–¢—Ä–µ–Ω–µ—Ä –ò–ò",
    "1770032788433": "–ê—Ä—Ö–µ–æ–ª–æ–≥",
    "9008969287495770": "–î–∏–∑–∞–π–Ω–µ—Ä –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤",
    "1770032798666": "–õ–∏–Ω–≥–≤–∏—Å—Ç"
  }

  const COLORS = [
    "#FF6384",
    "#36A2EB",
    "#FFCE56",
    "#4BC0C0",
    "#9966FF"
  ]

 const ctx = document.getElementById("chart")
  const chart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: [],
      datasets: [{
        data: [],
        backgroundColor: COLORS
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 500
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  })

  /* üì° –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• */
  async function fetchStats() {
    const res = await fetch("/api/stats")
    return await res.json()
  }

  /* üîÑ –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ò–ê–ì–†–ê–ú–ú–´ –ò –õ–ï–ì–ï–ù–î–´ */
  async function updateChart() {
    const stats = await fetchStats()
    const entries = Object.entries(stats)

    if (entries.length === 0) {
      chart.data.labels = []
      chart.data.datasets[0].data = []
      chart.update()
      document.getElementById("legend").innerHTML = ""
      return
    }

    const total = entries.reduce((sum, [, v]) => sum + v, 0)

    const labels = entries.map(([key]) => ANSWER_LABELS[key] ?? key)
    const values = entries.map(([, v]) => v)

    chart.data.labels = labels
    chart.data.datasets[0].data = values
    chart.update()

    const legend = document.getElementById("legend")
    legend.innerHTML = ""

    entries.forEach(([key, value], index) => {
      const percent = ((value / total) * 100).toFixed(1)

      legend.innerHTML += `
        <div class="legend-item">
          <div class="legend-color" style="background:${COLORS[index]}"></div>
          ${ANSWER_LABELS[key] ?? key}: ${percent}%
        </div>
      `
    })
  }

  /* üîÅ LIVE-–û–ë–ù–û–í–õ–ï–ù–ò–ï */
  updateChart()
  setInterval(updateChart, REFRESH_INTERVAL)

  /* üî¥ –°–ë–†–û–° */
  document.getElementById("resetBtn").onclick = async () => {
    const ok = confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?")
    if (!ok) return

    await fetch("/api/reset", { method: "POST" })
    updateChart()
  }
</script>

</body>
</html>
