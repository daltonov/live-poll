<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Результаты голосования</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .container {
      display: flex;
      align-items: center;
      gap: 40px;
    }

    .legend {
      font-size: 18px;
      min-width: 220px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .color-box {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      border-radius: 4px;
    }

    .placeholder {
      text-align: center;
      color: #999;
      font-size: 20px;
    }
  </style>
</head>
<body>

<div class="container">
  <canvas id="chart" width="360" height="360"></canvas>
  <div class="legend" id="legend"></div>
</div>

<script>
  const colors = [
    "#FF6384",
    "#36A2EB",
    "#FFCE56",
    "#4BC0C0"
  ];

  const chart = new Chart(document.getElementById("chart"), {
    type: "pie",
    data: {
      labels: ["Ожидание голосов"],
      datasets: [{
        data: [1],
        backgroundColor: ["#e0e0e0"]
      }]
    },
    options: {
      plugins: {
        legend: { display: false }
      },
      animation: {
        duration: 300
      }
    }
  });

  async function update() {
    const res = await fetch("/api/stats");
    const data = await res.json();

    if (!data.total || data.total === 0) {
      document.getElementById("legend").innerHTML =
        `<div class="placeholder">Ожидание голосов…</div>`;
      return;
    }

    chart.data.labels = data.labels;
    chart.data.datasets[0].data = data.values;
    chart.data.datasets[0].backgroundColor = colors;
    chart.update();

    const legend = document.getElementById("legend");
    legend.innerHTML = "";

    data.labels.forEach((label, i) => {
      const item = document.createElement("div");
      item.className = "legend-item";
      item.innerHTML = `
        <div class="color-box" style="background:${colors[i % colors.length]}"></div>
        <div>${label}: <b>${data.percents[i]}%</b></div>
      `;
      legend.appendChild(item);
    });
  }

  update();
  setInterval(update, 2000);
</script>

</body>
</html>
